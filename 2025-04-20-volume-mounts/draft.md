üò† **–ê–≥–µ–Ω—Ç –Ω–µ –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–µ –º–∞—É–Ω—Ç—ã? –†–∞–∑–±–∏—Ä–∞–µ–º—Å—è —Å `mountPropagation` –≤ Kubernetes!**

–ü–∏—Å–∞–ª —è –Ω–µ–¥–∞–≤–Ω–æ IO –ª–∏–º–∏—Ç–µ—Ä –¥–ª—è LVM —Ç–æ–º–æ–≤ –∫—É–±–µ—Ä–∞ –∏ —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π: –∑–∞–ø—É—Å–∫–∞—é –∞–≥–µ–Ω—Ç –ª–∏–º–∏—Ç–µ—Ä–∞, –æ–Ω –≤–∏–¥–∏—Ç –≤—Å–µ –º–∞—É–Ω—Ç—ã –ø–æ–¥–æ–≤ (–º–∞—É–Ω—Ç—ã –º–Ω–µ –±—ã–ª–∏ –Ω—É–∂–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è MAJOR:MINOR –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –±–ª–æ—á–Ω–æ–≥–æ —É—Å—Ç—Ä–æ—Å—Ç—Ä–æ–π—Å—Ç–∞ –∫–æ—Ç–æ—Ä–æ–µ —è —Ö–æ—á—É –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å) –∏ –≤—Å–µ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ—Ç–æ–º –Ω–∞ —Ö–æ—Å—Ç –ø—Ä–∏–µ–∑–∂–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ–¥ –∏ —è –Ω–µ –≤–∏–∂—É –µ–≥–æ –º–∞—É–Ω—Ç–∞.

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ –ø–æ–º–æ–≥–∞–ª, –Ω–æ —ç—Ç–æ –∂–µ –∫–æ—Å—Ç—ã–ª—å!

**–í —á–µ–º –∫–æ—Ä–µ–Ω—å –∑–ª–∞?**

–í—Å–µ –¥–µ–ª–æ –≤ **Linux mount namespaces**. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π "–º–∏—Ä" –º–∞—É–Ω—Ç–æ–≤ (—ç—Ç–æ –∫–∞–∫ `private` propagation –≤ Linux, –∏–ª–∏ `mountPropagation: None` –≤ Kubernetes). –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Ö–æ—Å—Ç–µ (–Ω–æ–≤—ã–µ PV) –≤ —ç—Ç–æ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏—Ä –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç.

**–ö–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å? `mountPropagation` —Å–ø–µ—à–∏—Ç –Ω–∞ –ø–æ–º–æ—â—å!**

–í Kubernetes –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `mountPropagation` —É `volumeMounts`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º. –í—Å–µ–≥–æ —Ç—Ä–∏ —Ä–µ–∂–∏–º–∞:

1. `None` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è (`private`).
2. `HostToContainer`: –ú–∞—É–Ω—Ç—ã —Å —Ö–æ—Å—Ç–∞ **–ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è** –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –Ω–æ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç (`rslave` –≤ Linux). –¢–æ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ!
3. `Bidirectional`: –ú–∞—É–Ω—Ç—ã —Ö–æ–¥—è—Ç –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã - —Å —Ö–æ—Å—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ò –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ —Ö–æ—Å—Ç (`rshared` –≤ Linux). **–û–ø–∞—Å–Ω–æ!** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å –±–æ–ª—å—à–æ–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è –∞–≥–µ–Ω—Ç–∞:**

–ß—Ç–æ–±—ã –º–æ–π –∞–≥–µ–Ω—Ç –≤–∏–¥–µ–ª –Ω–æ–≤—ã–µ PV, –º–æ–Ω—Ç–∏—Ä—É–µ–º—ã–µ kubelet'–æ–º (–æ–±—ã—á–Ω–æ –≤ `/var/lib/kubelet/pods`), –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `HostToContainer`:

```yaml
spec:
  containers:
  - name: my-agent
    image: my-agent-image
    volumeMounts:
    - name: kubelet-pods-dir
      mountPath: /var/lib/kubelet/pods # –ö—É–¥–∞ –º–æ–Ω—Ç–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
      mountPropagation: HostToContainer # <--- –ú–∞–≥–∏—è –∑–¥–µ—Å—å!
  volumes:
  - name: kubelet-pods-dir
    hostPath:
      path: /var/lib/kubelet/pods # –ß—Ç–æ –º–æ–Ω—Ç–∏—Ä—É–µ–º —Å —Ö–æ—Å—Ç–∞
      type: DirectoryOrCreate
```

**–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º:**

–ï—Å–ª–∏ –∫—Ä–∞—Ç–∫–æ: Kubelet –≤–∏–¥–∏—Ç `HostToContainer`, –≥–æ–≤–æ—Ä–∏—Ç Container Runtime Interface (CRI) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `PROPAGATION_HOST_TO_CONTAINER`. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π —Ä–∞–Ω—Ç–∞–π–º (containerd, CRI-O) —É–∂–µ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã Linux –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç mount namespace –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ `rslave` –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ —Ö–æ—Å—Ç–æ–≤–æ–º—É –º–∞—É–Ω—Ç—É.

**–ò—Ç–æ–≥:**

–° `HostToContainer` –≤–∞—à –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ –º–∞—É–Ω—Ç—ã, –ø–æ—è–≤–ª—è—é—â–∏–µ—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞. –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

# kubernetes #k8s #mountpropagation #linux #namespaces #devops #kubelet #internals #storage #volumes

**–°—Å—ã–ª–∫–∏**

- [–ö–æ–¥ –∫—É–±–µ—Ä–∞](https://github.com/kubernetes/cri-api/blob/v0.32.4/pkg/apis/runtime/v1/api.proto#L210)
- [–î–æ–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ –∫—É–±–µ—Ä–∞](https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation)
- [–°–æ–æ—Ç–≤–µ—Å—Ç–≤—É—é—â–∏–π man](https://man7.org/linux/man-pages/man8/mount.8.html)
